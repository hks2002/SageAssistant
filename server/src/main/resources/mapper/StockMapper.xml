<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sageassistant.dao.StockMapper">
	<!--Open L2 Cache under Names pace: 1 Hour -->
	<cache eviction="LRU" flushInterval="3600000" readOnly="true"
		size="1024" />
	<select id="findStockInfoByPnRoot" parameterType="String" resultType="sageassistant.model.StockInfo">
		SELECT DISTINCT
			STOCK.STOFCY_0 AS StockSite,
			STOCK.ITMREF_0 AS PN,
			SUM(STOCK.QTYSTU_0) OVER (PARTITION BY STOCK.STOFCY_0,STOCK.ITMREF_0 ) AS QTY
		FROM
			EXPLOIT.STOCK
		LEFT JOIN EXPLOIT.ITMMASTER
			ON ITMMASTER.ITMREF_0=STOCK.ITMREF_0
		WHERE
			ITMMASTER.ITMREF_0=#{pnRoot}
		GROUP BY 
			STOCK.STOFCY_0,
			STOCK.ITMREF_0
	</select>
	<select id="findStockSummaryBySite" parameterType="String" resultType="sageassistant.model.StockSummary">
		SELECT DISTINCT
			LEFT(ITMMASTER.TSICOD_0,1) AS G,
			LEFT(ITMMASTER.ITMREF_0,1) AS A,
			STOCK.ITMREF_0 AS PN,
			ITMMASTER.ITMDES1_0 + IIF(ITMMASTER.ITMDES2_0!='',' ' +ITMMASTER.ITMDES2_0,'') +IIF(ITMMASTER.ITMDES3_0!='',' ' +ITMMASTER.ITMDES3_0,'')  AS Description,
			SUM(STOCK.QTYSTU_0) OVER (PARTITION BY STOCK.STOFCY_0,STOCK.ITMREF_0 ) AS Qty,
			SUM(STOCOST.CST_0) OVER (PARTITION BY STOCK.STOFCY_0,STOCK.ITMREF_0 ) AS Cost
		FROM STOCK
		LEFT JOIN ITMMASTER
			ON ITMMASTER.ITMREF_0 = STOCK.ITMREF_0
		LEFT JOIN STOCOST
			ON STOCOST.ITMREF_0 = STOCK.ITMREF_0
		WHERE
			STOCK.STOFCY_0=#{Site}
			AND STOCOST.STOFCY_0=#{Site}
		ORDER BY STOCK.ITMREF_0
	</select>
	<select id="findStockHistoryBySite" parameterType="String" resultType="sageassistant.model.StockHistory">
		SELECT DISTINCT
			STOJOU.LOC_0 AS Location,
			STOJOU.CSTCOU_0 AS Seq,
			STOJOU.ITMREF_0 AS PN,
			ITMMASTER.ITMDES1_0 + IIF(ITMMASTER.ITMDES2_0='','',' '+ITMMASTER.ITMDES2_0) + IIF(ITMMASTER.ITMDES3_0='','',' '+ITMMASTER.ITMDES3_0) AS Description,
			STOJOU.QTYSTU_0 AS Qty,
			STOJOU.STU_0 AS Unit,
			STOJOU.AMTVAL_0 AS Cost,
			STOJOU.PJT_0 AS ProjectNO,
			STOJOU.VCRNUMORI_0 AS SourceNO,
			STOJOU.VCRLINORI_0 AS SourceLine,
			STOJOU.VCRNUM_0 AS EntryNO,
			STOJOU.VCRLIN_0 AS EntryLine,
			STOJOU.CREUSR_0 AS CreateUser,
			STOJOU.CREDAT_0 AS CreateDate
		FROM 
			STOJOU 
		LEFT JOIN ITMMASTER
			ON ITMMASTER.ITMREF_0 = STOJOU.ITMREF_0
		WHERE
			STOJOU.STOFCY_0=#{Site}
			AND (STOJOU.CREDAT_0 BETWEEN CONVERT(datetime, #{DateFrom},120) AND CONVERT(datetime, #{DateTo},120) )
			AND
			(
			ITMMASTER.ITMDES1_0 LIKE #{PnOrName} OR
			ITMMASTER.ITMDES2_0 LIKE #{PnOrName} OR
			ITMMASTER.ITMDES2_0 LIKE #{PnOrName} OR
			STOJOU.ITMREF_0 LIKE #{PnOrName}
			) 
		ORDER BY STOJOU.CREDAT_0 ASC
	</select>

</mapper>